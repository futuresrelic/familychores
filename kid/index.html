<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>My Chores</title>
    
    <!-- Google Fonts for Fun Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Baloo+2:wght@400;700&family=Fredoka:wght@400;700&family=Playfair+Display:wght@400;700&family=Chewy&family=Orbitron:wght@400;700&family=Dancing+Script:wght@400;700&family=Luckiest+Guy&family=Press+Start+2P&family=Permanent+Marker&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/kid-favicon.ico">
    <link rel="shortcut icon" href="/assets/kid-favicon.ico">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Chores">
    <link rel="apple-touch-icon" href="/assets/kid-icon-192.png">
</head>
<body>
    <!-- Pairing Screen -->
    <div id="pairing-screen" class="screen">
        <div class="pairing-container">
            <div class="logo">
                <svg width="80" height="80" viewBox="0 0 60 60">
                    <circle cx="30" cy="30" r="25" fill="#4F46E5"/>
                    <path d="M20 30 L27 37 L40 24" stroke="white" stroke-width="3" fill="none"/>
                </svg>
            </div>
            <h1>Welcome to Family Chores!</h1>
            <p>Enter your pairing code to get started</p>
            <form id="pairing-form">
                <input type="text" id="pairing-code" placeholder="Enter Code" maxlength="6" required>
                <button type="submit">Pair Device</button>
                <div id="pairing-error" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="screen hidden">
        <header>
            <div class="header-left">
                <div class="avatar" id="kid-avatar">K</div>
                <div class="header-info">
                    <h2 id="kid-name" class="kid-name">Loading...</h2>
                    <div class="points-display" id="kid-points">‚≠ê 0 points</div>
                </div>
            </div>
            <button id="refresh-btn" class="icon-btn" title="Refresh">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
    </svg>
</button>

<!-- UPDATE BUTTON -->
<button id="update-btn" class="icon-btn update-available" title="Update Available" style="display: none;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
    </svg>
</button>
        </header>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-view="chores">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span>Chores</span>
            </button>
            <button class="nav-btn" data-view="quests">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                <span>Quests</span>
            </button>
            <button class="nav-btn" data-view="game">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
                    <path d="M6 11h4M8 9v4M16 10h.01M18 12h.01"></path>
                </svg>
                <span>Game</span>
            </button>
            <button class="nav-btn" data-view="rewards">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="8" r="7"></circle>
                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                </svg>
                <span>Rewards</span>
            </button>
            <button class="nav-btn" data-view="history">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>History</span>
            </button>
            <button class="nav-btn" data-view="settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97 1.313l-6-1.732m-6 0l-6 1.732m15.142-8.485l-4.243 4.243m-2.828 2.828l-4.243 4.243"></path>
                </svg>
                <span>Settings</span>
            </button>
        </nav>

        <main>
            <!-- Chores View -->
            <section id="view-chores" class="view active">
                <h2 class="view-title">Today's Chores</h2>
                <div id="chores-list" class="card-list"></div>
            </section>

            <!-- Quests View -->
            <section id="view-quests" class="view">
                <h2 class="view-title">Active Quests</h2>
                <div id="quests-list" class="card-list"></div>
            </section>

<!-- Game View -->
<section id="view-game" class="view">
    <div style="text-align: center; padding: 20px;">
        
<!-- Game Selector -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px;">
    <button class="game-selector-btn active" data-game="stars" style="padding: 12px; border: 2px solid #4F46E5; background: #EEF2FF; color: #4F46E5; border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center; font-size: 14px;">
        ‚≠ê Star Catcher
    </button>
    <button class="game-selector-btn" data-game="math" style="padding: 12px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center; font-size: 14px;">
        üßÆ Math Quest
    </button>
    <button class="game-selector-btn" data-game="music" style="padding: 12px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center; font-size: 14px;">
        üéµ Beat Master
    </button>
    <button class="game-selector-btn" data-game="leaderboard" style="padding: 12px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center; font-size: 14px;">
        üèÜ Leaderboard
    </button>
</div>
        
        <!-- ‚≠ê STAR CATCHER GAME -->
        <div id="game-stars" class="game-content">
            <h2 style="font-size: 24px; margin-bottom: 10px;">‚≠ê Star Catcher</h2>
            <p style="color: #6B7280; margin-bottom: 20px;">Tap the falling stars!</p>
            
            <div id="stars-difficulty-selector" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button class="difficulty-btn active" data-difficulty="easy" data-game="stars" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #10B981; background: #D1FAE5; color: #065F46; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    üòä Easy
                </button>
                <button class="difficulty-btn" data-difficulty="medium" data-game="stars" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    ü§î Medium
                </button>
                <button class="difficulty-btn" data-difficulty="hard" data-game="stars" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    üò± Hard
                </button>
            </div>
            
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 16px;">
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Score</div>
                    <div id="stars-score" style="font-size: 32px; font-weight: bold; color: #4F46E5;">0</div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Combo</div>
                    <div id="stars-combo" style="font-size: 32px; font-weight: bold; color: #F59E0B;">0x</div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Best</div>
                    <div id="stars-high-score" style="font-size: 32px; font-weight: bold; color: #10B981;">0</div>
                </div>
            </div>
            
            <div id="stars-container" style="position: relative; width: 100%; height: 400px; background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%); border-radius: 20px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                <div id="stars-timer-bar" style="position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #10B981;"></div>
            </div>
            
            <button id="stars-start-btn" class="btn btn-primary" style="width: 100%; max-width: 300px; padding: 15px; font-size: 18px;">
                üéÆ Start Game
            </button>
            
            <div id="stars-game-over" style="display: none; margin-top: 20px; padding: 20px; background: rgba(79, 70, 229, 0.9); color: white; border-radius: 16px;">
                <div style="font-size: 16px; margin-bottom: 10px;">‚è±Ô∏è Time's Up!</div>
                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">Final Score: <span id="stars-final-score">0</span></div>
                <div id="stars-high-score-msg" style="font-size: 14px; color: #FCD34D; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- üßÆ MATH QUEST GAME -->
        <div id="game-math" class="game-content" style="display: none;">
            <h2 style="font-size: 24px; margin-bottom: 10px;">üßÆ Math Quest</h2>
            <p style="color: #6B7280; margin-bottom: 20px;">Solve as many problems as you can!</p>
            
            <div id="math-difficulty-selector" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button class="difficulty-btn active" data-difficulty="easy" data-game="math" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #10B981; background: #D1FAE5; color: #065F46; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    üòä Easy
                </button>
                <button class="difficulty-btn" data-difficulty="medium" data-game="math" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    ü§î Medium
                </button>
                <button class="difficulty-btn" data-difficulty="hard" data-game="math" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    üò± Hard
                </button>
            </div>
            
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 16px;">
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Score</div>
                    <div id="math-score" style="font-size: 32px; font-weight: bold; color: #10B981;">0</div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Streak</div>
                    <div id="math-streak" style="font-size: 32px; font-weight: bold; color: #F59E0B;">0üî•</div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Best</div>
                    <div id="math-high-score" style="font-size: 32px; font-weight: bold; color: #4F46E5;">0</div>
                </div>
            </div>
            
            <div id="math-game-area" style="padding: 40px; background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); border-radius: 20px; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                <div id="math-timer-bar" style="position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #10B981;"></div>
                <div id="math-problem" style="font-size: 48px; font-weight: bold; color: #065F46; margin-bottom: 30px; min-height: 60px;">Ready?</div>
                <div id="math-answers" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 300px;">
                    <!-- Answer buttons will be inserted here -->
                </div>
            </div>
            
            <button id="math-start-btn" class="btn btn-primary" style="width: 100%; max-width: 300px; padding: 15px; font-size: 18px; background: #10B981;">
                üßÆ Start Math Quest
            </button>
            
            <div id="math-game-over" style="display: none; margin-top: 20px; padding: 20px; background: rgba(16, 185, 129, 0.9); color: white; border-radius: 16px;">
                <div style="font-size: 16px; margin-bottom: 10px;">‚è±Ô∏è Time's Up!</div>
                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">Final Score: <span id="math-final-score">0</span></div>
                <div id="math-high-score-msg" style="font-size: 14px; color: #FCD34D; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- üéµ BEAT MASTER GAME -->
        <div id="game-music" class="game-content" style="display: none;">
            <h2 style="font-size: 24px; margin-bottom: 10px;">üéµ Beat Master</h2>
            <p style="color: #6B7280; margin-bottom: 20px;">Remember and repeat the pattern!</p>
            
            <div id="music-difficulty-selector" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button class="difficulty-btn active" data-difficulty="easy" data-game="music" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #10B981; background: #D1FAE5; color: #065F46; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    üòä Easy
                </button>
                <button class="difficulty-btn" data-difficulty="medium" data-game="music" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    ü§î Medium
                </button>
                <button class="difficulty-btn" data-difficulty="hard" data-game="music" style="flex: 1; max-width: 100px; padding: 10px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 12px; font-weight: 600; cursor: pointer;">
                    üò± Hard
                </button>
            </div>
            
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 16px;">
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Level</div>
                    <div id="music-level" style="font-size: 32px; font-weight: bold; color: #EC4899;">1</div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Score</div>
                    <div id="music-score" style="font-size: 32px; font-weight: bold; color: #8B5CF6;">0</div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #6B7280;">Best</div>
                    <div id="music-high-score" style="font-size: 32px; font-weight: bold; color: #F59E0B;">0</div>
                </div>
            </div>
            
            <div id="music-status" style="padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 16px; margin-bottom: 20px; font-size: 18px; font-weight: 600; color: #8B5CF6;">
                Watch and remember! üëÄ
            </div>
            
            <div id="music-pad-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 350px; margin: 0 auto 20px;">
                <button class="music-pad" data-color="red" data-note="C" style="aspect-ratio: 1; border-radius: 20px; border: none; background: linear-gradient(135deg, #EF4444, #DC2626); box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5); cursor: pointer; font-size: 32px; transition: all 0.1s;">
                    üî¥
                </button>
                <button class="music-pad" data-color="blue" data-note="E" style="aspect-ratio: 1; border-radius: 20px; border: none; background: linear-gradient(135deg, #3B82F6, #2563EB); box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5); cursor: pointer; font-size: 32px; transition: all 0.1s;">
                    üîµ
                </button>
                <button class="music-pad" data-color="green" data-note="G" style="aspect-ratio: 1; border-radius: 20px; border: none; background: linear-gradient(135deg, #10B981, #059669); box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5); cursor: pointer; font-size: 32px; transition: all 0.1s;">
                    üü¢
                </button>
                <button class="music-pad" data-color="yellow" data-note="A" style="aspect-ratio: 1; border-radius: 20px; border: none; background: linear-gradient(135deg, #F59E0B, #D97706); box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5); cursor: pointer; font-size: 32px; transition: all 0.1s;">
                    üü°
                </button>
            </div>
            
            <button id="music-start-btn" class="btn btn-primary" style="width: 100%; max-width: 300px; padding: 15px; font-size: 18px; background: #8B5CF6;">
                üéµ Start Beat Master
            </button>
            
            <div id="music-game-over" style="display: none; margin-top: 20px; padding: 20px; background: rgba(139, 92, 246, 0.9); color: white; border-radius: 16px;">
                <div style="font-size: 16px; margin-bottom: 10px;">‚ùå Wrong Pattern!</div>
                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">Final Level: <span id="music-final-level">0</span></div>
                <div style="font-size: 20px; margin-bottom: 10px;">Score: <span id="music-final-score">0</span></div>
                <div id="music-high-score-msg" style="font-size: 14px; color: #FCD34D; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- üèÜ LEADERBOARD -->
        <div id="game-leaderboard" class="game-content" style="display: none;">
            <h2 style="font-size: 24px; margin-bottom: 10px;">üèÜ Leaderboard</h2>
            
            <!-- Game Type Selector for Leaderboard -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="leaderboard-game-btn active" data-game="stars" style="padding: 8px 16px; border: 2px solid #4F46E5; background: #EEF2FF; color: #4F46E5; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ‚≠ê Stars
                </button>
                <button class="leaderboard-game-btn" data-game="math" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    üßÆ Math
                </button>
                <button class="leaderboard-game-btn" data-game="music" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    üéµ Music
                </button>
            </div>
            
            <!-- Period Filter -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="period-btn active" data-period="today" style="padding: 8px 16px; border: 2px solid #4F46E5; background: #EEF2FF; color: #4F46E5; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    üìÖ Today
                </button>
                <button class="period-btn" data-period="week" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    üìÜ This Week
                </button>
                <button class="period-btn" data-period="month" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    üìä This Month
                </button>
                <button class="period-btn" data-period="all" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    üåü All Time
                </button>
            </div>
            
            <!-- Difficulty Filter -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; justify-content: center;">
                <button class="leaderboard-difficulty-btn active" data-difficulty="all" style="padding: 8px 16px; border: 2px solid #10B981; background: #D1FAE5; color: #065F46; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    All
                </button>
                <button class="leaderboard-difficulty-btn" data-difficulty="easy" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Easy
                </button>
                <button class="leaderboard-difficulty-btn" data-difficulty="medium" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Medium
                </button>
                <button class="leaderboard-difficulty-btn" data-difficulty="hard" style="padding: 8px 16px; border: 2px solid #E5E7EB; background: white; color: #6B7280; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Hard
                </button>
            </div>
            
            <div id="leaderboard-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Leaderboard entries will be populated here -->
            </div>
        </div>
        
    </div>
</section>
            <!-- Rewards View -->
            <section id="view-rewards" class="view">
                <h2 class="view-title">Available Rewards</h2>
                <div id="rewards-list" class="card-list"></div>
            </section>

            <!-- History View -->
            <section id="view-history" class="view">
                <h2 class="view-title">My History</h2>
                <div id="history-list" class="card-list"></div>
            </section>

            <!-- Settings View -->
<section id="view-settings" class="view">
    <h2>My Settings</h2>
    
    <!-- Single Compact Card -->
    <div class="settings-section">
        <div class="card" style="padding: 16px;">
            
            <!-- Avatar Type - Horizontal -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 14px;">Avatar</label>
                <div style="display: flex; gap: 10px;">
                    <div class="avatar-type-option active" data-avatar="logo" style="flex: 1; padding: 10px; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: white; border: 3px solid #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <img src="/assets/kid-icon-192.png" style="width: 40px; height: 40px; border-radius: 50%;">
                        </div>
                        <span style="font-size: 12px; color: #6B7280; font-weight: 600;">Icon</span>
                    </div>
                    
                    <div class="avatar-type-option" data-avatar="initial" style="flex: 1; padding: 10px; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: white; border: 3px solid #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #4F46E5;">
                            A
                        </div>
                        <span style="font-size: 12px; color: #6B7280; font-weight: 600;">Initial</span>
                    </div>
                    
                    <div class="avatar-type-option" data-avatar="border" id="border-style-option" style="flex: 1; padding: 10px; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; text-align: center;">
                        <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: white; border: 3px solid #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            üé®
                        </div>
                        <span style="font-size: 12px; color: #6B7280; font-weight: 600;">Border</span>
                    </div>
                </div>
                <input type="file" id="avatar-photo-input" accept="image/*" capture="user" style="display: none;">
            </div>
            
            <!-- Border Color -->
            <div style="margin-bottom: 16px;">
                <label for="avatar-border-color" style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 14px;">Border Color</label>
                <input type="color" id="avatar-border-color" value="#4F46E5" style="width: 100%; height: 44px; border: 2px solid #E5E7EB; border-radius: 6px; cursor: pointer; padding: 3px;">
            </div>
            
            <!-- Theme Selector Button -->
<div style="margin-bottom: 20px;">
    <button id="open-theme-modal-btn" class="btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; padding: 12px;">
        üé® Choose a Theme
    </button>
</div>

            <!-- PREVIEW -->
            <div style="margin-bottom: 16px; padding: 14px; background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%); border-radius: 8px; border: 2px solid #E5E7EB;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="avatar" id="preview-avatar" style="width: 50px; height: 50px; border: 3px solid #4F46E5; background: white; color: #4F46E5; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; border-radius: 50%;">A</div>
                    <div>
                        <div class="kid-name" id="preview-name">Your Name</div>
                        <div style="font-size: 12px; color: #6B7280;">‚≠ê 30 points</div>
                    </div>
                </div>
            </div>
            
            <hr style="border: none; border-top: 1px solid #E5E7EB; margin: 16px 0;">
            
            <!-- Name Settings - Compact Two Column -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                
                <!-- LEFT: Font -->
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 14px;">Font</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 2px solid #E5E7EB; border-radius: 6px; padding: 4px; background: #F9FAFB;">
                        <div class="font-option active" data-font="default" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: -apple-system, sans-serif; font-size: 14px;">Default</span>
                        </div>
                        <div class="font-option" data-font="comic" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Comic Neue', cursive; font-size: 14px;">Comic</span>
                        </div>
                        <div class="font-option" data-font="playful" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Baloo 2', sans-serif; font-size: 14px;">Playful</span>
                        </div>
                        <div class="font-option" data-font="bold" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Fredoka', sans-serif; font-weight: bold; font-size: 14px;">Bold</span>
                        </div>
                        <div class="font-option" data-font="elegant" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Playfair Display', serif; font-size: 14px;">Elegant</span>
                        </div>
                        <div class="font-option" data-font="bubbly" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Chewy', cursive; font-size: 14px;">Bubbly</span>
                        </div>
                        <div class="font-option" data-font="techno" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Orbitron', monospace; font-size: 14px;">Techno</span>
                        </div>
                        <div class="font-option" data-font="fancy" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Dancing Script', cursive; font-size: 14px;">Fancy</span>
                        </div>
                        <div class="font-option" data-font="chunky" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Luckiest Guy', sans-serif; font-size: 14px;">Chunky</span>
                        </div>
                        <div class="font-option" data-font="retro" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer; margin-bottom: 4px;">
                            <span style="font-family: 'Press Start 2P', monospace; font-size: 10px;">Retro</span>
                        </div>
                        <div class="font-option" data-font="marker" style="padding: 8px; border: 2px solid #E5E7EB; border-radius: 4px; background: white; cursor: pointer;">
                            <span style="font-family: 'Permanent Marker', cursive; font-size: 14px;">Marker</span>
                        </div>
                    </div>
                    <input type="hidden" id="name-font" value="default">
                </div>
                
                <!-- RIGHT: Color & Size -->
                <div>
                    <label for="name-color" style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 14px;">Color</label>
                    <input type="color" id="name-color" value="#1F2937" style="width: 100%; height: 44px; border: 2px solid #E5E7EB; border-radius: 6px; cursor: pointer; padding: 3px; margin-bottom: 12px;">
                    
                    <label for="name-size" style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 14px;">Size: <span id="name-size-value" style="color: #4F46E5;">18px</span></label>
                    <input type="range" id="name-size" min="14" max="32" value="18" step="1" style="width: 100%;">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%; padding: 12px; margin-top: 4px;">Save Changes</button>
        </div>
    </div>
</section>
        </main>
    </div>

    <!-- Confetti Container -->
    <canvas id="confetti-canvas"></canvas>

    <!-- Icon Selector Modal -->
    <div id="icon-selector-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content-kid" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; font-size: 18px;">Choose Your Avatar</h3>
            
            <!-- Filter Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #E5E7EB; padding-bottom: 8px;">
                <button id="filter-all" class="filter-tab active" style="flex: 1; padding: 8px; border: none; background: #EEF2FF; color: #4F46E5; border-radius: 6px; font-weight: 600; cursor: pointer;">All</button>
                <button id="filter-default" class="filter-tab" style="flex: 1; padding: 8px; border: none; background: #F3F4F6; color: #6B7280; border-radius: 6px; font-weight: 600; cursor: pointer;">Preset</button>
                <button id="filter-user" class="filter-tab" style="flex: 1; padding: 8px; border: none; background: #F3F4F6; color: #6B7280; border-radius: 6px; font-weight: 600; cursor: pointer;">My Photos</button>
            </div>
            
            <!-- Avatar Grid -->
            <div id="avatar-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; max-height: 400px; overflow-y: auto; padding: 8px;">
                <!-- Populated by JavaScript -->
            </div>
            
            <!-- Upload Button (for user photos) -->
            <div id="upload-section" style="margin-bottom: 16px; display: none;">
                <button id="upload-avatar-btn" class="btn" style="width: 100%; background: #10B981; color: white;">
                    üì∑ Upload New Photo (Max 3)
                </button>
                <input type="file" id="avatar-upload-input" accept="image/*" capture="user" style="display: none;">
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="select-avatar-btn" style="flex: 1;">Select Avatar</button>
                <button class="btn" id="cancel-avatar-btn" style="flex: 1; background: #6B7280; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Border Style Modal -->
    <div id="border-style-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content-kid" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; font-size: 18px;">Choose Border Style üé®</h3>
            
            <!-- Border Style Grid -->
            <div id="border-style-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                
                <!-- Solid -->
                <div class="border-style-choice" data-style="solid" data-width="3" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 3px solid #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5;">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Solid</span>
                </div>
                
                <!-- Thick -->
                <div class="border-style-choice" data-style="solid" data-width="5" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 5px solid #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5;">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Thick</span>
                </div>
                
                <!-- Dashed -->
                <div class="border-style-choice" data-style="dashed" data-width="3" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 3px dashed #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5;">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Dashed</span>
                </div>
                
                <!-- Dotted -->
                <div class="border-style-choice" data-style="dotted" data-width="3" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 3px dotted #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5;">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Dotted</span>
                </div>
                
                <!-- Double -->
                <div class="border-style-choice" data-style="double" data-width="5" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 5px double #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5;">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Double</span>
                </div>
                
                <!-- Glow -->
                <div class="border-style-choice" data-style="glow" data-width="3" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 3px solid #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5; box-shadow: 0 0 15px rgba(79, 70, 229, 0.6);">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Glow</span>
                </div>
                
                <!-- Rainbow -->
                <div class="border-style-choice" data-style="gradient" data-width="4" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #FFA07A); padding: 3px; border-radius: 50%;">
                        <div style="width: 100%; height: 100%; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4F46E5;">A</div>
                    </div>
                    <span style="font-size: 13px; font-weight: 600;">Rainbow</span>
                </div>
                
                <!-- Neon -->
                <div class="border-style-choice" data-style="neon" data-width="3" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 8px; border: 3px solid #00FF88; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #00FF88; box-shadow: 0 0 20px rgba(0, 255, 136, 0.8), inset 0 0 10px rgba(0, 255, 136, 0.3);">A</div>
                    <span style="font-size: 13px; font-weight: 600;">Neon</span>
                </div>
                
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px;">
                <button class="btn" id="cancel-border-btn" style="flex: 1; background: #6B7280; color: white;">Cancel</button>
            </div>
        </div>
    </div>

<!-- Theme Modal -->
<div id="theme-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content-kid" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 16px; font-size: 18px;">Choose Your Theme üé®</h3>
        
        <p style="font-size: 13px; color: #6B7280; margin-bottom: 16px;">Pick a theme to instantly update your colors, font, and border!</p>
        
        <!-- Theme Grid -->
        <div id="theme-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
            
            <!-- Ocean Adventure -->
            <div class="theme-choice" data-theme="ocean" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üåä</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Ocean</div>
                <div style="font-size: 11px; color: #6B7280;">Adventure</div>
            </div>
            
            <!-- Sunset Vibes -->
            <div class="theme-choice" data-theme="sunset" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üåÖ</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Sunset</div>
                <div style="font-size: 11px; color: #6B7280;">Vibes</div>
            </div>
            
            <!-- Forest Quest -->
            <div class="theme-choice" data-theme="forest" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üå≤</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Forest</div>
                <div style="font-size: 11px; color: #6B7280;">Quest</div>
            </div>
            
            <!-- Space Explorer -->
            <div class="theme-choice" data-theme="space" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üöÄ</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Space</div>
                <div style="font-size: 11px; color: #6B7280;">Explorer</div>
            </div>
            
            <!-- Cotton Candy -->
            <div class="theme-choice" data-theme="candy" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üç≠</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Cotton</div>
                <div style="font-size: 11px; color: #6B7280;">Candy</div>
            </div>
            
            <!-- Lava Zone -->
            <div class="theme-choice" data-theme="lava" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üåã</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Lava</div>
                <div style="font-size: 11px; color: #6B7280;">Zone</div>
            </div>
            
            <!-- Mint Ice Cream -->
            <div class="theme-choice" data-theme="mint" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üç¶</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Mint</div>
                <div style="font-size: 11px; color: #6B7280;">Ice Cream</div>
            </div>
            
            <!-- Midnight Magic -->
            <div class="theme-choice" data-theme="midnight" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üåô</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Midnight</div>
                <div style="font-size: 11px; color: #6B7280;">Magic</div>
            </div>
            
            <!-- Rainbow Party -->
            <div class="theme-choice" data-theme="rainbow" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üåà</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Rainbow</div>
                <div style="font-size: 11px; color: #6B7280;">Party</div>
            </div>
            
            <!-- Retro Arcade -->
            <div class="theme-choice" data-theme="retro" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üëæ</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Retro</div>
                <div style="font-size: 11px; color: #6B7280;">Arcade</div>
            </div>
            
            <!-- Desert Gold -->
            <div class="theme-choice" data-theme="desert" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">üèúÔ∏è</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Desert</div>
                <div style="font-size: 11px; color: #6B7280;">Gold</div>
            </div>
            
            <!-- Arctic Freeze -->
            <div class="theme-choice" data-theme="arctic" style="padding: 16px; border: 2px solid #E5E7EB; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 32px; margin-bottom: 8px;">‚ùÑÔ∏è</div>
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Arctic</div>
                <div style="font-size: 11px; color: #6B7280;">Freeze</div>
            </div>
            
        </div>
        
        <!-- Action Button -->
        <div style="display: flex; gap: 10px;">
            <button class="btn" id="close-theme-modal-btn" style="flex: 1; background: #6B7280; color: white;">Close</button>
        </div>
        
        <p style="font-size: 11px; color: #6B7280; margin-top: 12px; text-align: center;">üí° Themes apply instantly! Don't forget to click "Save Changes" below.</p>
    </div>
</div>

<script>
        // Enhanced auto-versioning system - loads CSS and JS with cache-busting
        fetch('/api/version.php')
        .then(r => r.json())
        .then(data => {
            // Load CSS with version
            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = `kid.css?v=${data.timestamp}`;
            document.head.appendChild(css);
            
            // Load JS with version
            const script = document.createElement('script');
            script.src = `kid.js?v=${data.timestamp}`;
            document.body.appendChild(script);
            
            console.log('‚úÖ Loaded version:', data.version, 'timestamp:', data.timestamp);
        })
        .catch(() => {
            // Fallback if version fetch fails
            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = 'kid.css?v=' + Date.now();
            document.head.appendChild(css);
            
            const script = document.createElement('script');
            script.src = 'kid.js?v=' + Date.now();
            document.body.appendChild(script);
        });
</script>

<script>
    // PWA Update Detection - Check only when app becomes active
    let newWorker;
    let currentVersion = null;
    let lastCheckTime = 0;
    const CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes
    
    async function checkForUpdates() {
        const now = Date.now();
        
        // Don't check if we checked less than 5 minutes ago
        if (now - lastCheckTime < CHECK_INTERVAL) {
            return;
        }
        
        lastCheckTime = now;
        
        try {
            const response = await fetch('/api/version.php', { cache: 'no-store' });
            const data = await response.json();
            const serverVersion = data.version;
            
            if (currentVersion === null) {
                currentVersion = serverVersion;
                console.log('Initial version:', currentVersion);
            } else if (serverVersion !== currentVersion) {
                console.log('üéâ New version detected:', serverVersion, '(was:', currentVersion + ')');
                
                // Show update button
                const updateBtn = document.getElementById('update-btn');
                if (updateBtn) {
                    updateBtn.style.display = 'flex';
                    updateBtn.classList.add('pulse-animation');
                }
                
                currentVersion = serverVersion;
            }
        } catch (error) {
            console.error('Error checking version:', error);
        }
    }
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/kid/sw.js')
            .then((reg) => {
                console.log('Service Worker Registered');
                
                // Check immediately
                checkForUpdates();
                
                // Check when page becomes visible (tab switching back)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        checkForUpdates();
                    }
                });
                
                // Also check when window regains focus
                window.addEventListener('focus', () => {
                    checkForUpdates();
                });
                
                reg.addEventListener('updatefound', () => {
                    newWorker = reg.installing;
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('New service worker installed, prompting update...');
                            checkForUpdates();
                        }
                    });
                });
            })
            .catch(err => console.log('Service Worker Registration Failed:', err));
    }
</script>
</body>
</html>